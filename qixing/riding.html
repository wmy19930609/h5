<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Riding</title>
    <meta charset="utf-8">
    <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1">
    <meta content=always name=referrer>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="date=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta content="telephone=no" name="format-detection">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta itemprop="name" content="与京妞er一起骑行">
    <meta itemprop="description" content="环游中国骑行100天，寻找1%的生活">
    <link rel="shortcut icon" href="http://s3.qhimg.com/static/c56696ff943031e3.ico" type="image/x-icon" />
    <script src="./static/js/rem.js"></script>
    <link rel="stylesheet" href="./static/css/riding.css">
</head>

<body>
    <div id="wrapper">
        <div class="page page1">
            <div class="kids"></div>
        </div>
        <div class="outer">
            <div class="page page2">
                <div class="kids"></div>
            </div>
            <div class="page page3">
                <!--<img class="bg-img" src="./static/img/bg3bk.png">-->
                <div class="city-popup"></div>
                <div class="other-city"></div>
                <a href="javascript:;" bk="follow"><button class="btn follow-btn js-follow"></button></a>
            </div>
        </div>
    </div>
    <!--引入打点代码-->
    <script src="http://s8.qhimg.com/static/2afc71670295f3b8/jquery,qw.core.js"></script>
    <script src="http://s6.qhimg.com/static/ab69bff62405ffb7/utils.js"></script>
    <script src="http://s7.qhimg.com/static/98c707edc784aedb/monitor.js"></script>
    <script src="./static/js/data_monitor.js"></script>
    <script>$.noConflict();</script>
    <script src="http://s6.qhimg.com/static/88422eda07b71a23/m/libs/zepto.js"></script>
    <script src="http://play3.kandian.360.cn/vod_xinwen/btime/tools/blogin.js?v=1"></script>
    <script>
        function flipOver(){
            var $page2 = $('#wrapper .page2');
            var startX, startY, changeX, changeY;
            var y = $(window).height();
            $page2.on('touchstart', function(e){
                startY = e.targetTouches[0].pageY;
            });

            $page2.on('touchend', function(e){
                changeY = e.changedTouches[0].pageY;
                if(changeY - startY <= 0){
                    $('.page3').css({
                        '-webkit-transform' : 'translate3d(0px, 0px, 0px);',
                        'transform' : 'translate3d(0px, 0px, 0px);'
                    }).addClass('anim');

                    $('.page2').css({
                        '-webkit-transform' : 'translate3d(0px, -' + y + 'px, 0px);',
                        'transform' : 'translate3d(0px, -' + y + 'px, 0px);'
                    }).addClass('anim');

                    $('.page2 .kids').remove();
                    $('body').css('overflow','auto');
                }
            });
        }

        function drawCity(){
            var cityList = ['zjk', 'zy', 'ts', 'yc', 'kkth', 'wlmq', 'kksl', 'kns', 'klmy', 'sw', 'tklmg', 'xzx'];
            var urlList = [
                'http://item.btime.com/46pmkan4l5j8a09ocinl5adm617',
                'http://item.btime.com/43ur92mg6a09jc9fmpbll02h26q',
                'http://item.btime.com/43gs8h5q03g9kc8451eh9m6h9r0',
                'http://item.btime.com/4345s56f77083sbhqq9116haskr',
                'http://item.btime.com/43fbqep088e9upa8htg1taifn1p',
                'http://item.btime.com/40lio7u10cm9h6adtqm36if2ia5',
                'http://item.btime.com/44b647hi2fa95eb8r7tbcj6panm',
                'http://item.btime.com/43ii3r3ue9484k9ndv7moqnvfvo',
                'http://item.btime.com/426u1egkgff8qp9vsmrihd9eual',
                'http://item.btime.com/422nk1ihidd9in9klb887ddedgu',
                'http://item.btime.com/46o8ugto7f69bbau53rd6ijv5n9',
                'http://item.btime.com/41evnuv7v779f48sf8n1ht8ror1'
            ];
            var imgList = [
                'http://p5.qhimg.com/t011d4c278f24a1f05d.png',
                'http://p7.qhimg.com/t01052253e7d89978fe.png',
                'http://p9.qhimg.com/t01b59ec379e07b4b7b.png',
                'http://p6.qhimg.com/t01d5a7f27bb47c5904.png',
                'http://p4.qhimg.com/t0136cdfe0a271a04dc.png',
                'http://p2.qhimg.com/t016d7c1a8cbcce7a72.png',
                'http://p9.qhimg.com/t01024cfacfde8c2a9f.png',
                'http://p7.qhimg.com/t01906c6fde384a613c.png',
                'http://p1.qhimg.com/t01390d7aca55d85ea9.png',
                'http://p6.qhimg.com/t01f7a11e228384b832.png',
                'http://p1.qhimg.com/t01886c41b41a273a8a.png',
                'http://p5.qhimg.com/t01f90851ca070bb15e.png'
            ];
            var popImgList = [
                'http://p5.qhimg.com/t011330424620ac10fc.png',
                'http://p3.qhimg.com/t014687f26f9dea592b.png',
                'http://p5.qhimg.com/t01c4165b39a6296718.png',
                'http://p7.qhimg.com/t01840b9323d1363a35.png',
                'http://p3.qhimg.com/t013c7652dae0965c7c.png',
                'http://p3.qhimg.com/t01b54553ec1869c566.png',
                'http://p1.qhimg.com/t015342b6a42919a792.png',
                'http://p4.qhimg.com/t01c16a7e47f978640a.png',
                'http://p2.qhimg.com/t016d07460e3a0ce753.png',
                'http://p0.qhimg.com/t0142a501d52e4b21d3.png',
                'http://p0.qhimg.com/t01f79dc4e2409be3b9.png',
                'http://p1.qhimg.com/t0153754afd502ae895.png'
            ];
            var dom = '';
            cityList.forEach(function(city, index){
                dom += '<div class="'+ city +' city">' +
                            '<img class="city-icon" src="'+ imgList[index] +'" />' +
                            '<a href="'+ urlList[index] +'">' +
                                '<img class="'+ city +'-pop popup" src="'+ popImgList[index] +'" />' +
                            '</a>' +
                        '</div>';
            });
            $('.city-popup').append(dom)
        }

        function voteCity(){
            var cityList = ['km', 'lj', 'dl', 'gz', 'gl', 'qd', 'sh', 'xm', 'hz'];
            var initVotes = {};
            var dom = '';
            var cityVote = [];
            var isPoll = [];
            
            $.ajax({
                url: 'http://voteapi.btime.com/v2/poll/results',
                data: { 'subjId':  2352, 'depMd5': '889675bcbdc82c50260173446d19d4bd'},
                dataType: 'jsonp',
                method: 'POST',
                callback: 'vote',
                success: function(res){
                    var option = res.data.ret && res.data.ret[0]&& res.data.ret[0].option;
                    if(option){
                        option.forEach(function(vote){
                            cityVote.push(vote.total);
                            isPoll.push(vote.isPoll)
                        });
                        
                    }
                    cityList.forEach(function(city, index){
                        dom += '<div class="'+ city +' js-vote-city" data-ispoll="'+ (isPoll[index]) +'">' +
                                    '<span class="votes">'+ (cityVote[index] || 0) +'</span>' +
                                '</div>';
                    });
                    $('.other-city').append(dom)
                },
                fail: function(err){
                    console.log(err)
                }
             });
        }
        function init(){
            $('body').scrollTop(0)
            flipOver();
            drawCity();
            voteCity();

            $(".page2").height($(window).height());
            var y = $(window).height();
            $('.page3').css({
                '-webkit-transform' : 'translate3d(0px, ' + y + 'px, 0px);',
                'transform' : 'translate3d(0px, ' + y + 'px, 0px);'
            });

            $('.js-follow').on('click', function(){
                var $this = $(this)
                mLogin.init({ stopTouchMove: false, closeTips: true }, function(){
                    mLogin.login(function(data){
                        $.ajax({
                            url: 'http://record.btime.com/sub',
                            data: { 'c_id':  307831},
                            dataType: 'jsonp',
                            callback: 'follow',
                            success: function(res){
                                if(res.errno == 0 && res.data.length){
                                    common_monitor.init({basePar: {pid: 'riding'}});
                                    alert('关注成功')
                                }else if(res.errno == 0 && res.data.length == 0){
                                    alert('你已经关注过了哦')
                                }
                            },
                            fail: function(err){
                                console.log(err)
                            }
                        });
                    });
                });
            });

            $('.other-city').on('click', '.js-vote-city', function(event){
                event.stopPropagation();
                var $this = $(this);
                var cityName = /\w+\b/.exec($(this).attr('class'))[0];
                var voteCityIds = {
                    'dl': 6169, 'gl': 6170, 'gz': 6171, 
                    'hz': 6172, 'km': 6173, 'lj': 6174, 
                    'qd': 6175, 'sh': 6176, 'xm': 6177 
                };
                $.ajax({
                    url: 'http://voteapi.btime.com/v1/poll/voting',
                    data: { 'subjId': 2352,  'itemId': 1172, 'id': voteCityIds[cityName],'depMd5': '889675bcbdc82c50260173446d19d4bd'},
                    dataType: 'jsonp',
                    method: 'POST',
                    callback: 'vote',
                    success: function(res){
                        var $targetCity = $('.' + cityName);
                        var startVote = +$targetCity.find('.votes').text();
                        $targetCity.find('.vote-result').remove();
                        if(res.errno == 1){
                            $('<span class="vote-result"></span>').addClass(cityName + '-vote').text('+1').appendTo('.other-city .' + cityName)
                            $('.' + cityName).find('.votes').text(startVote + 1)
                        }else{
                            alert('你已经投过票了哦')
                        }
                    },
                    fail: function(err){
                        console.log(err)
                    }
                });
                
            });
            $('#wrapper').on('click', function(e){
                var $target = $(e.target).closest('.city-icon')
                if(!$target){
                    $('.popup').hide()
                }else{
                        $('.popup').hide()
                        $target.next().find('.popup').show()
                    }
            })
        }
        init()
    </script>
</body>

</html>