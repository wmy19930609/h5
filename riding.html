<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Riding</title>
    <meta charset="utf-8">

    <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1">
    <meta content=always name=referrer>

    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">

    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="date=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta content="telephone=no" name="format-detection">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">

    <link rel="shortcut icon" href="http://s3.qhimg.com/static/c56696ff943031e3.ico" type="image/x-icon" />

    <script src="./rem.js"></script>
    <link rel="stylesheet" href="./riding.css">
</head>
<body>
    <div id="wrapper">
        <div class="page page1"><div class="kids"></div></div>
        <div class="page page2">
            <img class="intro-img" src="http://p0.qhimg.com/t0127620ecbb018d5c9.png">
            <div class="kids"></div>
            <span class="backward"></span>
        </div>
        <div class="page page3">
            <img class="bg-img" src="./img/bg3.png">
            <div class="city-popup"></div>
            <div class="other-city"><span class="vote-result">+1</span></div>
            <button class="btn follow-btn js-follow"></button>
        </div>
    </div>

    <script src="http://s6.qhimg.com/static/88422eda07b71a23/m/libs/zepto.js"></script>

    <script>
        function flipOver(){
            var $page2 = $('#wrapper .page2');
            var startX, startY, changeX, changeY;
            var y = $('#wrapper').height();
            $page2.on('touchstart', function(e){
                startY = e.targetTouches[0].pageY;
            });

            $page2.on('touchend', function(e){
                changeY = e.changedTouches[0].pageY;
                if(changeY - startY < 0){
                    $page2.css({
                        '-webkit-transform' : 'translate3d(0px, -' + y + 'px, 0px);',
                        'transform' : 'translate3d(0px, -' + y + 'px, 0px);'
                    }).addClass('anim');
                }
            });
        }

        function drawCity(){
            var cityList = ['zjk', 'zy', 'ts', 'yc', 'kkth', 'wlmq', 'kksl', 'kns', 'klmy', 'sw', 'tklmg', 'xzx'];
            var dom = '';
            cityList.forEach(function(city){
                dom += '<div class="'+ city +' city">' +
                            '<img class="city-icon" src="./img/'+ city +'.png" />' +
                            '<img class="'+ city +'-pop popup" src="./img/'+ city +'-pop.png" />' +
                        '</div>';
            });
            $('.city-popup').append(dom)
        }

        function voteCity(){
            var cityList = ['km', 'lj', 'dl', 'gz', 'gl', 'qd', 'sh', 'xm', 'hz'];
            var initVotes = {};
            var dom = '';
            var cityVote = [];
            var isPoll = [];
            $.ajax({
                url: 'http://votet.btime.com/v2/poll/results',
                data: { 'subjId':  2345, 'depMd5': '889675bcbdc82c50260173446d19d4bd'},
                dataType: 'jsonp',
                method: 'POST',
                callback: 'vote',
                success: function(res){
                    var option = res.data.ret && res.data.ret[0]&& res.data.ret[0].option;
                    if(option){
                        option.forEach(function(vote){
                            cityVote.push(vote.total);
                            isPoll.push(vote.isPoll)
                        });
                    }

                    cityList.forEach(function(city, index){
                        dom += '<div class="'+ city +' js-vote-city" data-ispoll="'+ isPoll[index] +'">' +
                                    '<span class="votes">'+ cityVote[index] +'</span>' +
                                '</div>';
                    });
                    $('.other-city').append(dom)
                },
                fail: function(err){
                    console.log(err)
                }
            });
        }
        
        function init(){
            flipOver();
            drawCity();
            voteCity();

            $('.js-follow').on('click', function(){
                var $this = $(this)
                $.ajax({
                    url: 'http://record.btime.com/sub',
                    data: { 'c_id':  307831},
                    dataType: 'jsonp',
                    callback: 'follow',
                    success: function(res){
                        if(res.errno == 0 && res.data.length){
                            $this.removeClass('follow-btn').addClass('not-follow')
                        }
                    },
                    fail: function(err){
                        console.log(err)
                    }
                });
            });

            $('.other-city').on('click', '.js-vote-city', function(){
                var $this = $(this);
                var cityName = /\w+\b/.exec($(this).attr('class'))[0];
                var voteCityIds = {
                    'dl': 6067, 'gl': 6068, 'gz': 6069, 
                    'hz': 6070, 'km': 6071, 'lj': 6072, 
                    'qd': 6073, 'sh': 6074, 'xm': 6075 
                };
                $.ajax({
                    url: 'http://votet.btime.com/v1/poll/voting',
                    data: { 'subjId': 2345,  'itemId': 1149, 'id': voteCityIds[cityName],'depMd5': '889675bcbdc82c50260173446d19d4bd'},
                    dataType: 'jsonp',
                    method: 'POST',
                    callback: 'vote',
                    success: function(res){
                        if(res.errno == 1){

                        }
                    },
                    fail: function(err){
                        console.log(888,err)
                    }
                });
                
            });

            $('.city-popup').on('click', '.city-icon', function(){
                var targetCity = /\w+\b/.exec($(this).parents('.city').attr('class'))[0]
                $('.popup').hide()
                $(this).next('.popup').show()                
            })
        }

        init()
    </script>
</body>
</html>